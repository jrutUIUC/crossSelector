stdnms[2]
stdnms<- unique(pheno$studyName)
for(i in 1:length(stdnms)){
#Single trial analysis
phenosub<- pheno[which(pheno$studyName==stdnms[i]), ]
phenosub$blockNumber<- as.factor(phenosub$blockNumber)
model<- lm(Heading.time...Julian.date..JD..CO_321.0001233~1+germplasmName+blockNumber, phenosub)
means<- emmeans(model, specs='germplasmName')
means<- data.frame(means)
means<- data.frame(means, study=stdnms[i])
if(i==1){
meansAll<- means
}else{
meansAll<- rbind(meansAll, means)
}
}
View(meansAll)
plot(meansAll$SE)
library(lme4)
head(meansAll)
model2<- lmer(emmean~1+(1|germplasmName)+(1|study),
weights=1/meansAll$SE^2, meansAll)
model2<- lmer(emmean~1+(1|germplasmName)+(1|study),
weights=1/meansAll$SE^2, meansAll)
summary(model2)
str(model2)
library(arm)
blups<- ranef(model2)$germplasmName
blups
hist(blups)
hist(blups[,1])
blupsSe<- se.ranef(model2)$germplasmName
blupsSe
head(blupsSe)
blupsSe<- blupsSe[,1]
blupsSe
blupsPEV<- blupsSe^2
summary(model2)
rel<- 1- blupsPEV/1.267
rel
hist(rel)
summary(model2)
VarCorr(model2)
as.data.frame(VarCorr(model2))
as.data.frame(VarCorr(model2))['germplasmName', 'vcov']
as.data.frame(VarCorr(model2))['germplasmName', 'vcov']
as.data.frame(VarCorr(model2))[1, 'vcov']
##Step 2 of analysis - mixed model, genotypes iid
#This time using the rrBLUP package
y<- meansAll$emmean
X<- model.matrix(emmean~1+study, meansAll)
View(x)
View(X)
head(meansAll)
Z<- model.matrix(emmean~0+germplasmName, meansAll)
View(Z)
#pre-multiply design matrices by the inverse of the square root of the
#R matrix to account for heterogenous error variances
y2<- y/meansAll$SE
X2<- X/meansAll$SE
Z2<- Z/meansAll$SE
modMixedsolve<- mixed.solve(y2, Z=Z2, X=X2)
meansAll
head(meansALl)
head(meansAll)
unique(meansAll$study)
which(meansAll$study %in% c('Pr_Neo_21', 'Pr_Urb_21'))
##Step 2 of analysis - mixed model, genotypes iid
#This time using the rrBLUP package
ix<- which(meansAll$study %in% c('Pr_Neo_21', 'Pr_Urb_21'))
meansAll<- meansAll[-ix,]
y<- meansAll$emmean
X<- model.matrix(emmean~1+study, meansAll)
Z<- model.matrix(emmean~0+germplasmName, meansAll)
#pre-multiply design matrices by the inverse of the square root of the
#R matrix to account for heterogenous error variances
y2<- y/meansAll$SE
X2<- X/meansAll$SE
Z2<- Z/meansAll$SE
modMixedsolve<- mixed.solve(y2, Z=Z2, X=X2)
setwd("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/Teaching/CPSC554/2024/Class 16")
geno<- read.csv('WheatGenoAll.csv')
pheno<- read.csv('WheatPheno21-23Data.csv')
library(emmeans)
library(rrBLUP)
library(lme4)
stdnms<- unique(pheno$studyName)
for(i in 1:length(stdnms)){
#Single trial analysis
phenosub<- pheno[which(pheno$studyName==stdnms[i]), ]
phenosub$blockNumber<- as.factor(phenosub$blockNumber)
model<- lm(Heading.time...Julian.date..JD..CO_321.0001233~1+germplasmName+blockNumber, phenosub)
means<- emmeans(model, specs='germplasmName')
means<- data.frame(means)
means<- data.frame(means, study=stdnms[i])
if(i==1){
meansAll<- means
}else{
meansAll<- rbind(meansAll, means)
}
}
#Step 2 of analysis - mixed model, genotypes iid
model2<- lmer(emmean~1+(1|germplasmName)+(1|study),
weights=1/meansAll$SE^2, meansAll)
library(arm)
blups<- ranef(model2)$germplasmName
blupsSe<- se.ranef(model2)$germplasmName
blupsSe<- blupsSe[,1]
blupsPEV<- blupsSe^2
rel<- 1- blupsPEV/as.data.frame(VarCorr(model2))[1, 'vcov']
y<- meansAll$emmean
X<- model.matrix(emmean~1+study, meansAll)
Z<- model.matrix(emmean~0+germplasmName, meansAll)
det(X)
det(Z)
Xi<- solve(X1)
Xi<- solve(X2)
Xi<- solve(X2)
library(rrBLUP)
install.packages('rrBLUP')
install.packages("rrBLUP")
library(rrBLUP)
y<- meansAll$emmean
X<- model.matrix(emmean~1+study, meansAll)
Z<- model.matrix(emmean~0+germplasmName, meansAll)
#pre-multiply design matrices by the inverse of the square root of the
#R matrix to account for heterogenous error variances
y2<- y/meansAll$SE
X2<- X/meansAll$SE
Z2<- Z/meansAll$SE
modMixedsolve<- mixed.solve(y2, Z=Z2, X=X2)
pheno<- read.csv('WheatPheno21-23Data.csv')
setwd("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/Teaching/CPSC554/2024/Class 16")
geno<- read.csv('WheatGenoAll.csv')
pheno<- read.csv('WheatPheno21-23Data.csv')
library(emmeans)
library(rrBLUP)
library(lme4)
stdnms<- unique(pheno$studyName)
for(i in 1:length(stdnms)){
#Single trial analysis
phenosub<- pheno[which(pheno$studyName==stdnms[i]), ]
phenosub$blockNumber<- as.factor(phenosub$blockNumber)
model<- lm(Heading.time...Julian.date..JD..CO_321.0001233~1+germplasmName+blockNumber, phenosub)
means<- emmeans(model, specs='germplasmName')
means<- data.frame(means)
means<- data.frame(means, study=stdnms[i])
if(i==1){
meansAll<- means
}else{
meansAll<- rbind(meansAll, means)
}
}
#Step 2 of analysis - mixed model, genotypes iid
model2<- lmer(emmean~1+(1|germplasmName)+(1|study),
weights=1/meansAll$SE^2, meansAll)
library(arm)
blups<- ranef(model2)$germplasmName
blupsSe<- se.ranef(model2)$germplasmName
blupsSe<- blupsSe[,1]
blupsPEV<- blupsSe^2
rel<- 1- blupsPEV/as.data.frame(VarCorr(model2))[1, 'vcov']
##Step 2 of analysis - mixed model, genotypes iid
#This time using the rrBLUP package
#ix<- which(meansAll$study %in% c('Pr_Neo_21', 'Pr_Urb_21'))
#meansAll<- meansAll[-ix,]
y<- meansAll$emmean
X<- model.matrix(emmean~1+study, meansAll)
Z<- model.matrix(emmean~0+germplasmName, meansAll)
#pre-multiply design matrices by the inverse of the square root of the
#R matrix to account for heterogenous error variances
y2<- y/meansAll$SE
X2<- X/meansAll$SE
Z2<- Z/meansAll$SE
modMixedsolve<- mixed.solve(y2, Z=Z2, X=X2)
X2
y<- meansAll$emmean
X<- model.matrix(emmean~0+study, meansAll)
Z<- model.matrix(emmean~0+germplasmName, meansAll)
#pre-multiply design matrices by the inverse of the square root of the
#R matrix to account for heterogenous error variances
y2<- y/meansAll$SE
X2<- X/meansAll$SE
Z2<- Z/meansAll$SE
modMixedsolve<- mixed.solve(y2, Z=Z2, X=X2)
str(modMixedsolve)
VarCorr(model2)
as.data.frame(VarCorr(model2))
VarCorr(model2)
as.data.frame(VarCorr(model2))
str(modMixedsolve)
geno[1:5, 1:5]
geno[,X]
geno[,'X']
View(geno[,'X'])
View(as.data.frame(geno[,'X']))
grep('P',geno[,'X'])
geno[,'X'][grep('P',geno[,'X'])]
geno[,'X'][grep('US17',geno[,'X'])]
geno[,'X'][grep('12-',geno[,'X'])]
geno[,'X'][grep('IL12-',geno[,'X'])]
geno[,'X'][grep('26004',geno[,'X'])]
geno[,'X'][grep('ILUS',geno[,'X'])]
str(modMixedsolve)
modMixedsolve$u
ranef(model2)$germplasmName
ranef(model2)$germplasmName[,1]
ranef(model2)$germplasmName[,1]
modMixedsolve$u
modMixedsolve$u,
plot(ranef(model2)$germplasmName[,1], modMixedsolve$u)
plot(ranef(model2)$germplasmName[,1], modMixedsolve$u)
colnames(Z2)
gsub('germplasmName', '', colnames(Z2))
gsub('germplasmName', '', colnames(Z2)) %in% geno$X
gsub('germplasmName', '', colnames(Z2)) !%in% geno$X
unique(gsub('germplasmName', '', colnames(Z2)) %in% geno$X)
which(gsub('germplasmName', '', colnames(Z2)) %in% geno$X ==FALSE)
modMixedsolve$u
plot(ranef(model2)$germplasmName[,1], modMixedsolve$u)
modMixedsolve<- mixed.solve(y2, Z=Z2, X=X2)
geno[1:5, 1:5]
geno[1:5, 1:5]
geno[,2]
geno[,3]
geno[,4]
geno[,5]
tail(geno[,5])
tail(geno[,5])
dim(geno)
colnames(Z2)
genoNames<- colnames(Z2)
genoNames<- gsub('germplasmName', "", genoNames)
genoNames
which(genoNames %in% geno$X)
which(geno$X %in% genoNames)
genoSub<- geno[which(geno$X %in% genoNames),]
genoNames %in% geno$X
which(genoNames %in% geno$X ==FALSE)
dim(genoSub)
genoSub$X %in% genoNames
which(genoSub$X %in% genoNames ==FALSE)
dim(genoSub)
dim(Z2)
which(meansAll$germplasmName %in% genoSub$X)
#Next we need to remove individuals in the phenotypic data
#that were not genotyped
meansAllsub<- meansAll[which(meansAll$germplasmName %in% genoSub$X),]
str(meansALl)
str(meansAll)
meansAllsub<- droplevels.data.frame(meansAllsub)
#create design matrices again
y<- meansAllsub$emmean
X<- model.matrix(emmean~0+study, meansAllsub)
Z<- model.matrix(emmean~0+germplasmName, meansAllsub)
#pre-multiply design matrices by the inverse of the square root of the
#R matrix to account for heterogenous error variances
y2<- y/meansAllsub$SE
X2<- X/meansAllsub$SE
Z2<- Z/meansAll$SE
#create design matrices again
y<- meansAllsub$emmean
X<- model.matrix(emmean~0+study, meansAllsub)
Z<- model.matrix(emmean~0+germplasmName, meansAllsub)
#pre-multiply design matrices by the inverse of the square root of the
#R matrix to account for heterogenous error variances
y2<- y/meansAllsub$SE
X2<- X/meansAllsub$SE
Z2<- Z/meansAllsub$SE
dim(Z2)
dim(genoSub)
i-2
i=2
mrk<- genoSub[,i]
mrk
table(mrk)
tb<- table(mrk)
tb[1]
tb[1]*2 + tb[2]
tb[1]*2 + tb[2]
tb
sum(tb)
sum(tb)*2
(tb[1]*2 + tb[2])/sum(tb)*2
tb[1]*2 + tb[2]
sum(tb)
sum(tb)*2
(tb[1]*2 + tb[2])/(sum(tb)*2)
q<- 1-p
p<- (tb[1]*2 + tb[2])/(sum(tb)*2)
q<- 1-p
min(c(p, q))
p
mafs<- c()
for( i in 2:ncol(genoSub)){
mrk<- genoSub[,i]
tb<- table(mrk)
p<- (tb[1]*2 + tb[2])/(sum(tb)*2)
q<- 1-p
maf<- min(c(p, q))
mafs<- append(mafs, maf)
}
mrkMean<- mean(genoSub[,i], na.rm=TRUE)
i=245
mean(genoSub[,i])
mrkMean<- mean(genoSub[,i], na.rm=TRUE)
mrkMean
i=246
i=245
mrk<- genoSub[,i]
mrk
tb<- table(mrk)
tb
i=246
mrk<- genoSub[,i]
tb<- table(mrk)
tb
table(mrk)
mrk
i
i=246
i=2
which(is.na(mrk))
which(is.na(mrk))
mrk<- genoSub[,i]
i
mrk
which(is.na(mrk))
i
which(is.na(mrk))
mrk
tb<- table(mrk)
tb
mafs<- c()
for( i in 2:ncol(genoSub)){
mrk<- genoSub[,i]
tb<- table(mrk)
tb<- (tb[1]*2 + tb[2])/(sum(tb)*2)
q<- 1-p
maf<- min(c(p, q))
mafs<- append(mafs, maf)
}
mafs
mafs<- c()
for( i in 2:ncol(genoSub)){
mrk<- genoSub[,i]
tb<- table(mrk)
tb<- (tb[1]*2 + tb[2])/(sum(tb)*2)
q<- 1-p
maf<- min(c(p, q))
mafs<- append(mafs, maf)
}
p
mafs
#Eliminate monomorphic markers
mafs<- c()
for( i in 2:ncol(genoSub)){
mrk<- genoSub[,i]
tb<- table(mrk)
p<- (tb[1]*2 + tb[2])/(sum(tb)*2)
q<- 1-p
maf<- min(c(p, q))
mafs<- append(mafs, maf)
}
mafs
plot(maf)
plot(mafs)
hist(mafs)
min(mafs)
which(is.na(mafs))
i=245
mrk<- genoSub[,i]
mrk
tb<- table(mrk)
tb
i
246
mrk<- genoSub[,i]
tb<- table(mrk)
mrk
tb
p<- (tb[1]*2 + tb[2])/(sum(tb)*2)
q<- 1-p
maf<- min(c(p, q))
maf
which(is.na(mafs))
i=246
mrk<- genoSub[,i]
tb<- table(mrk)
p<- (tb[1]*2 + tb[2])/(sum(tb)*2)
q<- 1-p
maf<- min(c(p, q))
maf
tb
mrk
mafs
which(mafs>= 0.01)
which(mafs>= 0.01)
subMrk<- which(mafs>= 0.01)
genoSub2<- genoSub[,-1]
genoSub3<- genoSub2[,subMrk]
dim(genoSub3)
dim(Z2)
colnames(Z2)[1:10]
genoSub[1:10,1]
#Create the relationship matrix
A<- A.mat(genoSub3)
A[1:5, 1:5]
row.names(A)<- genoSub$X
conames(A)<- genoSub$X
colnames(A)<- genoSub$X
A[1:5, 1:5]
?mixed.solve
#For the Z2 matrix, make it the same order as in A
Z2nms<- colnames(Z2)
Z2nms
Z2nms<- gsub('germplasmName', "" ,Z2nms)
Z2nms
A2<- A[Z2nms, Z2nms]
A2[1:5, 1:5]
Z2nms[1:5]
#Fit the mixed model
GBLUP<- mixed.solve(y2, Z2, K2, Z2)
#Fit the mixed model
GBLUP<- mixed.solve(y2, Z2, A2, Z2)
?mixed.solve
#Fit the mixed model
GBLUP<- mixed.solve(y2, Z2, A2, X2)
str(GBLUP)
ls()
save.image('GBLUP model.RData')
install_github("jrutUIUC/crossSelector")
library(devtools)
install_github("jrutUIUC/crossSelector")
library(devtools)
install_github("jrutUIUC/crossSelector")
# Genotypic data ----
# This script subsets the phenotypic and genotypic data, performs quality control,
# and creates a genomic relationship matrix (G matrix) for further analysis.
# Clean workspace
rm(list = objects())  # Removes all objects from the environment.
# Packages ----
library(tidyverse) # R packages for data science.
library(gaston) # Genetic Data Handling.
library(ASRgenomics) # R package for Genomic Selection Analysis in R.
# Load data ----
## Phenotypic data ----
## Marker data ----
Markers <- read.vcf('Data/25NOR_IL_rerun.vcf.gz') # Load VCF file containing genotype markers.
## Marker data ----
Markers <- read.vcf('Data/25NOR_IL_rerun.vcf.gz') # Load VCF file containing genotype markers.
setwd("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/GitHub/crossSelector")
setwd("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/GitHub/GS2025_BeforeHarvest")
## Marker data ----
Markers <- read.vcf('Data/25NOR_IL_rerun.vcf.gz') # Load VCF file containing genotype markers.
#Make data frame with names and synonyms
NamesTable<- data.frame(GBS_Name=Markers@ped$id)
#correct the line names
yrseries<- gsub("20", "", as.character(2000:2019))
for(i in 1:length(yrseries)){
Markers@ped$id<- gsub(paste("IL", yrseries[i], sep=""), yrseries[i], Markers@ped$id)
}
Markers@ped$id<- gsub('IL20-', "2020-", Markers@ped$id, fixed=TRUE)
Markers@ped$id<- gsub('IL21-', "IL2021-", Markers@ped$id, fixed=TRUE)
Markers@ped$id<- gsub('16LCSDH', "IL16LCSDH", Markers@ped$id)
Markers@ped$id<-gsub("PIO-25R74", "Pio25R74", Markers@ped$id)
Markers@ped$id<-gsub("KASKASKIA", "Kaskaskia", Markers@ped$id)
#Update data frame with names and synonyms
NamesTable<- data.frame(Name=Markers@ped$id, NamesTable)
#check that name corrections were done properly
View(NamesTable)
#check that there are no duplicates
table(table(NamesTable$Name)) #notice that there are 36 lines that were genotyped twice
genoM <- as.matrix(Markers) # Convert marker data to a matrix.
#make the row names just the corrected names
vec<-row.names(genoM)
vec2<-c()
for(i in 1:length(vec)){
vec2<- append(vec2, strsplit(vec[i], split=":")[[1]][2])
}
row.names(genoM)<- vec2
#look at genoM
genoM[1:5,1:5]
dim(genoM)
#for the duplicate genotypes, remove the one with more missing data
dupid<- names(which(table(vec2)>1))
dupid
ixrm<-c()
for(i in 1:length(dupid)){
ix_dupi<- which(dupid[i]==vec2)
mt<- genoM[ix_dupi,]
na<- c()
for(j in 1:nrow(mt)){
na<- append(na, length(which(is.na(mt[j, ]))))
}
ixrm<- append(ixrm, ix_dupi[which(na == max(na))])
}
genoM2<- genoM[-ixrm,] #removing the duplicate with more NAs
# Filter the molecular matrix based on quality control thresholds
genoM_filter <- qc.filtering(
M = genoM2,  # Input molecular matrix.
maf = 0.05,  # Minimum allele frequency threshold.
marker.callrate = 0.25,  # Minimum call rate per marker.
ind.callrate = 0.5,  # Minimum call rate per individual.
impute = F,  # No imputation of missing data
plots = T  # Generate plots for quality control.
)
dim(genoM_filter$M.clean)
dim(genoM_filter$M.clean)
genoM_filter$M.clean[1:5,1:5]
write.csv(genoM_filter$M.clean, file='25NOR_IL_rerun_SNPtable.csv')
getwd()
